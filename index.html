<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Undercover ‚Äî Sites & Sols Pollu√©s (Expert)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --accent:#2bb673;
      --accent-dark:#1e8f56;
      --text:#f6f9fb;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: "Inter", "Segoe UI", Roboto, Arial, sans-serif;
      color:var(--text);
      background: #02140a;
      min-height:100vh;
    }
    #vanta-bg { position:fixed; inset:0; z-index:0; }
    .overlay { position:relative; z-index:2; min-height:100vh;
              background: linear-gradient(180deg, rgba(0,10,6,0.45), rgba(0,0,0,0.6));
              padding:28px; display:flex; align-items:flex-start; justify-content:center; }
    .container { width:100%; max-width:1100px; margin:12px; }
    
    header{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:18px; flex-wrap: wrap; }
    h1{ margin:0; font-size:28px; display:flex; gap:12px; align-items:center; }
    p.lead{ margin:0; opacity:0.95; font-size:16px; }
    
    nav{ display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    .btn{ background:linear-gradient(180deg,var(--accent),var(--accent-dark)); color:white; padding:12px 16px; border-radius:12px; border:none; cursor:pointer; font-size:16px; transition: transform 0.1s; }
    .btn:hover { transform: translateY(-2px); }
    .btn.ghost{ background: rgba(255,255,255,0.06); color:var(--text); }
    
    .card{ background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.18)); border-radius:14px; padding:24px; margin-bottom:14px; box-shadow: 0 8px 28px rgba(0,0,0,0.45); border:1px solid rgba(255,255,255,0.03); }
    
    .screen{ display:none; }
    .screen.active{ display:block; animation:fadeIn .3s ease; }
    @keyframes fadeIn{ from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:none} }
    
    .roles-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; margin-top:10px; }
    .role-item { padding:12px; border-radius:10px; background: rgba(0,0,0,0.28); cursor:pointer; display:flex; gap:10px; align-items:flex-start; transition: transform .12s; border:1px solid rgba(255,255,255,0.02); }
    .role-item:hover{ transform:translateY(-4px); background: rgba(255,255,255,0.08); }
    
    select, input[type="text"], input[type="number"] { width:100%; padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.1); font-size:16px; background: rgba(0,0,0,0.4); color:var(--text); margin-bottom: 12px; }
    select option { background: #02140a; }

    #wordDisplay{ font-size:38px; font-weight:800; padding:20px; border-radius:12px; display:inline-block; margin-top:12px; background: rgba(255,255,255,0.05); color: #4ade80; text-shadow: 0 2px 10px rgba(74, 222, 128, 0.2); }
    
    .timer{ font-size:42px; font-weight:800; margin-top:8px; display:inline-block; padding:10px 20px; border-radius:10px; background: rgba(255,255,255,0.05); letter-spacing: 2px; }
    
    .vote-item{ background: rgba(255,255,255,0.03); padding:14px; border-radius:10px; display:flex; justify-content:space-between; align-items:center; font-size:18px; margin-bottom: 8px; cursor: pointer; transition: background 0.2s;}
    .vote-item:hover { background: rgba(255,255,255,0.1); }
    
    .banner{ background: rgba(40,120,60,0.9); padding:12px; border-radius:10px; font-weight:700; margin-bottom:12px; text-align:center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    
    .context-box { background: rgba(255,255,255,0.05); padding: 16px; border-radius: 8px; border-left: 4px solid var(--accent); margin-top: 10px; font-style: italic; line-height: 1.5; }

    /* Styles pour le dictionnaire */
    .dict-category { margin-top: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; color: var(--accent); font-size: 1.2em; font-weight: bold; text-transform: uppercase;}
    .dict-theme { margin-top: 15px; color: #8fe7a8; font-weight: bold; margin-left: 10px; }
    .dict-item { background: rgba(255,255,255,0.03); margin: 8px 0; padding: 10px; border-radius: 8px; margin-left: 20px; }
    .dict-pair { font-weight: 800; color: #fff; margin-bottom: 4px; }
    .dict-def { font-size: 0.9em; opacity: 0.8; font-style: italic; }

    @media (max-width:720px){ h1{ font-size:22px } #wordDisplay{ font-size:28px } .btn{ padding:10px 12px } }
  </style>
</head>
<body>
  <div id="vanta-bg"></div>

  <div class="overlay">
    <div class="container">
      <header>
        <div>
          <h1>üå± Undercover ‚Äî SSP</h1>
          <p class="lead">Trouve l'infiltr√© ‚Äî prot√®ge le territoire</p>
        </div>
        <nav>
          <button class="btn" onclick="show('menu')">üè† Menu</button>
          <button class="btn ghost" onclick="show('dictionaryScreen')">üìö Dictionnaire</button>
          <button class="btn ghost" onclick="show('rolesScreen')">üìò R√¥les</button>
          <button class="btn ghost" onclick="show('explainScreen')">üßæ R√®gles</button>
        </nav>
      </header>

      <main>
        <section id="menu" class="screen active">
          <div class="card center">
            <h2 style="margin-top:0;">Configuration de la partie</h2>
            
            <div style="display:flex; gap:20px; flex-wrap:wrap;">
              <div style="flex:1; min-width: 200px;">
                <label>1. Difficult√© :</label>
                <select id="difficultySelect" onchange="updateThemes()">
                  <option value="facile">Facile (Concepts de base)</option>
                  <option value="moyen">Moyen (Technique)</option>
                  <option value="difficile">Difficile (Expert/R√©glementaire)</option>
                </select>
              </div>
              <div style="flex:1; min-width: 200px;">
                <label>2. Sous-th√®me :</label>
                <select id="themeSelect">
                  </select>
              </div>
            </div>

            <div style="margin-top:24px; padding-top:24px; border-top:1px solid rgba(255,255,255,0.1);">
              <button class="btn" style="width:100%; font-size:18px; font-weight:bold;" onclick="show('setupScreen')">üéÆ Suivant : Joueurs</button>
            </div>
          </div>
        </section>

        <section id="dictionaryScreen" class="screen">
            <div class="card">
                <h2>üìö Dictionnaire des Mots & Contextes</h2>
                <div style="margin-bottom:20px; opacity:0.8;">Voici toutes les paires de mots et leurs distinctions techniques.</div>
                
                <div id="dictionaryContent" style="max-height: 60vh; overflow-y: auto; padding-right: 10px;">
                    </div>

                <div style="text-align:center; margin-top:20px;">
                    <button class="btn" onclick="show('menu')">Retour au Menu</button>
                </div>
            </div>
        </section>

        <section id="setupScreen" class="screen">
          <div class="card">
            <h2>üõ†Ô∏è Joueurs & R√¥les</h2>
            <div style="display:flex; gap:20px; flex-wrap:wrap;">
              <div style="flex:1; min-width:280px;">
                <label>Nombre de joueurs (3-20) :</label>
                <input id="playerCount" type="number" min="3" max="20" value="6" onchange="buildNameInputs()" />
                
                <div id="namesList" style="margin-top:15px; max-height: 300px; overflow-y:auto; padding-right:5px;"></div>
              </div>
              
              <div style="flex:1; min-width:280px;">
                <label>R√¥les sp√©ciaux (Optionnel)</label>
                <div id="rolesSelect" class="roles-grid"></div>
              </div>
            </div>

            <div style="margin-top:20px; display:flex; gap:10px;">
              <button class="btn" onclick="assignRolesAndWords()">Lancer la partie</button>
              <button class="btn ghost" onclick="show('menu')">Retour</button>
            </div>
          </div>
        </section>

        <section id="revealScreen" class="screen">
          <div class="card center" style="text-align:center;">
            <h2>üîí Distribution Secr√®te</h2>
            <p id="revealInstr" style="font-weight:700; font-size:20px; margin-bottom:30px;"></p>

            <button class="btn" id="seeBtn" style="font-size:20px; padding:15px 30px;" onclick="seeMyWord()">Voir mon mot</button>

            <div id="wordInfo" style="display:none; animation:fadeIn 0.3s;">
              <div id="wordDisplay">MOT</div>
              <div id="roleLabel" style="margin-top:15px; font-size:18px; opacity:0.9;"></div>
              <p style="opacity:0.6; font-size:14px; margin-top:20px;">M√©morise ton mot, puis clique ci-dessous.</p>
              <div style="margin-top:20px;">
                <button class="btn ghost" onclick="nextReveal()">Cacher & Joueur suivant</button>
              </div>
            </div>
          </div>
        </section>

        <section id="discussionScreen" class="screen">
          <div class="card">
            <div id="publicRoleBanner" class="banner" style="display:none;"></div>

            <h2>üïØÔ∏è Discussion ‚Äî Tour <span id="roundNumber">1</span></h2>
            <div style="text-align:center;">
              <div class="timer" id="timerDisplay">01:30</div>
              <div style="margin-top:20px;">
                <button class="btn" onclick="startDiscussion()">‚ñ∂Ô∏è Lancer Chrono</button>
                <button class="btn ghost" onclick="openVoting()">üó≥Ô∏è Passer au vote</button>
              </div>
            </div>

            <div id="votingArea" style="margin-top:25px; display:none; border-top:1px solid rgba(255,255,255,0.1); padding-top:20px;">
              <h3 style="margin-top:0;">Qui √©liminer ?</h3>
              <div id="voteList"></div>
              <div style="margin-top:20px; text-align:center;">
                <button class="btn" style="background:#e74c3c;" onclick="collectVotes()">Confirmer le vote</button>
              </div>
            </div>
          </div>
        </section>

        <section id="afterScreen" class="screen">
          <div class="card center" style="text-align:center;">
            <h2>üì£ R√©sultat du vote</h2>
            <div id="afterContent" style="font-size:18px; margin:20px 0;"></div>
            <div style="text-align:center; margin-top:20px;">
              <button class="btn" onclick="proceedAfterVote()">Tour suivant</button>
              <button class="btn ghost" onclick="forceFinalReveal()">Arr√™ter la partie</button>
            </div>
          </div>
        </section>

        <section id="endScreen" class="screen">
          <div class="card center">
            <h2>üèÅ Fin de la partie</h2>
            <div id="endMessage" style="font-weight:800; font-size:22px; margin-bottom:20px; color:var(--accent);"></div>

            <div style="background:rgba(0,0,0,0.3); padding:20px; border-radius:12px; margin-bottom:20px;">
              <h3 style="margin-top:0; color:#4ade80;">üí° Le saviez-vous ?</h3>
              <p style="font-size:18px; margin-bottom:10px;">
                <strong>Mot Civil :</strong> <span id="endCivWord"></span><br>
                <strong>Mot Pollueur :</strong> <span id="endUnderWord"></span>
              </p>
              <div id="endContext" class="context-box"></div>
            </div>

            <h3>R√¥les r√©v√©l√©s</h3>
            <ul id="playersSummary" style="list-style:none; padding:0;"></ul>

            <div style="margin-top:24px; text-align:center;">
              <button class="btn" onclick="location.reload()">Rejouer</button>
              <button class="btn ghost" onclick="show('menu')">Menu Principal</button>
            </div>
          </div>
        </section>

        <section id="rolesScreen" class="screen">
          <div class="card">
            <h2>üìò R√¥les du jeu</h2>
            <div id="rolesGrid" class="roles-grid"></div>
            <button class="btn ghost" style="margin-top:20px;" onclick="show('menu')">Retour</button>
          </div>
        </section>

        <section id="explainScreen" class="screen">
          <div class="card">
            <h2>üßæ R√®gles</h2>
            <p><strong>But :</strong> Les Civils ont le m√™me mot. L'Infiltr√© a un mot tr√®s proche. Mister White n'a pas de mot.</p>
            <ol>
              <li>Chacun re√ßoit son mot secret.</li>
              <li>D√©battez pour trouver qui ne connait pas le mot exact.</li>
              <li>Votez pour √©liminer un suspect.</li>
            </ol>
            <button class="btn ghost" onclick="show('menu')">Retour</button>
          </div>
        </section>

      </main>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r121/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.fog.min.js"></script>

  <script>
    /* ===== VANTA BACKGROUND ===== */
    try {
      VANTA.FOG({
        el: "#vanta-bg",
        highlightColor: 0x8fe7a8,
        midtoneColor: 0x2bb673,
        lowlightColor: 0x08351a,
        baseColor: 0x02140a,
        blurFactor: 0.45,
        speed: 1.0,
        zoom: 0.9
      });
    } catch(e){ console.log("Vanta fallback"); }

    /* ===== DATA DU JEU ===== */
    const GAME_DATA = {
      facile: {
        "Concepts de pollution": [
          [["D√©pollution", "D√©contamination"], "La d√©pollution √©limine ou r√©duit la pollution d‚Äôun site et la d√©contamination retire des agents dangereux ; donc la d√©contamination est une d√©pollution plus sp√©cifique."],
          [["Pollution", "Contamination"], "La pollution d√©grade un milieu et la contamination est une pr√©sence locale ind√©sirable ; donc la contamination est plus cibl√©e que la pollution."],
          [["Risque", "Danger"], "Le danger peut causer un dommage et le risque est la probabilit√© qu‚Äôil survienne ; donc le risque d√©pend de l‚Äôexposition."]
        ],
        "√âtudes & analyses": [
          [["√âtude", "Rapport"], "L‚Äô√©tude est l‚Äôanalyse r√©alis√©e et le rapport est le document final ; donc le rapport est le r√©sultat de l‚Äô√©tude."],
          [["Pr√©l√®vement", "√âchantillon"], "Le pr√©l√®vement est l‚Äôaction de collecter et l‚Äô√©chantillon est ce qui est collect√© ; donc l‚Äôun est l‚Äôaction, l‚Äôautre le r√©sultat."],
          [["Sable", "Charbon actif"], "Le sable filtre m√©caniquement et le charbon actif retient chimiquement ; donc le sable enl√®ve les particules et le charbon absorbe les polluants."],
          [["Bassin", "R√©servoir"], "Les deux stockent l‚Äôeau mais le bassin est ouvert et le r√©servoir souvent ferm√© ; donc le bassin est expos√© √† l‚Äôair."]
        ],
        "Hydrog√©ologie simple": [
          [["Pi√©zom√®tre", "Forage"], "Le forage est le trou creus√© et le pi√©zom√®tre est l‚Äôinstallation instrument√©e qui y est plac√©e pour mesurer la nappe."],
          [["Sable", "Gravier"], "Le sable est fin et le gravier est plus gros ; donc ils se distinguent par la granulom√©trie et les propri√©t√©s hydrauliques."],
          [["Eau potable", "Eau brute"], "L‚Äôeau brute est pr√©lev√©e dans le milieu naturel et l‚Äôeau potable est trait√©e pour √™tre consomm√©e ; donc l‚Äôeau brute devient potable apr√®s traitement."],
          [["Source", "Fontaine"], "La source est l‚Äô√©mergence naturelle de l‚Äôeau et la fontaine est l‚Äôouvrage qui la distribue ; donc la fontaine exploite parfois une source."],
          [["Boues", "S√©diments"], "Les s√©diments sont des d√©p√¥ts naturels et les boues proviennent souvent du traitement ; donc les boues sont des s√©diments anthropis√©s."],
          [["Aquif√®re", "Aquitard"], "Aquif√®re = couche perm√©able qui contient de l‚Äôeau ; Aquitard = couche tr√®s peu perm√©able qui limite l‚Äô√©coulement."],
          [["Aquiclude", "Aquif√®re"], "L‚Äôaquif√®re contient et laisse circuler l‚Äôeau, l‚Äôaquiclude contient mais bloque l‚Äôeau ; donc l‚Äôaquiclude retient, l‚Äôaquif√®re transmet."]
        ]
      },
      moyen: {
        "Hydraulique & circulation": [
          [["Pompage", "Drainage"], "Le pompage extrait l‚Äôeau activement et le drainage l‚Äô√©vacue passivement ; donc l‚Äôun est actif, l‚Äôautre passif."],
          [["√âvaporation", "Volatilisation"], "L‚Äô√©vaporation transforme l‚Äôeau en vapeur et la volatilisation transforme un polluant en gaz ; donc l‚Äô√©vaporation concerne l‚Äôeau et la volatilisation les polluants."],
          [["Nappe libre", "Nappe captive"], "La nappe libre est ouverte √† l‚Äôair et la nappe captive est sous pression entre couches imperm√©ables ; donc la captive peut √™tre art√©sienne."],
          [["√âquipotentielle", "Ligne de courant"], "L‚Äô√©quipotentielle relie des points de m√™me charge et la ligne de courant suit l‚Äô√©coulement ; donc elles sont perpendiculaires."],
          [["Limite perm√©able", "Limite imperm√©able"], "Une limite perm√©able laisse passer l‚Äôeau et une limite imperm√©able la bloque ; donc la limite imperm√©able confine la nappe."],
          [["Dispersion", "Diffusion"], "La diffusion d√©pend du gradient de concentration et la dispersion ajoute l‚Äôeffet de l‚Äôh√©t√©rog√©n√©it√© du milieu ; donc la dispersion > diffusion dans les aquif√®res."]
        ],
        "Polluants & risques": [
          [["Hydrocarbure", "Benz√®ne"], "L‚Äôhydrocarbure est une mol√©cule C‚ÄìH et le benz√®ne en est une forme aromatique toxique ; donc le benz√®ne est un type d‚Äôhydrocarbure."],
          [["Toxique", "Biodisponible"], "Toxique signifie nocif et biodisponible signifie absorbable ; donc un polluant peut √™tre toxique sans √™tre biodisponible."],
          [["D√©chet", "R√©sidu"], "Le d√©chet est abandonn√© et le r√©sidu est ce qui reste d‚Äôun proc√©d√© ; donc un r√©sidu peut devenir un d√©chet."],
          [["Bact√©rie", "Micro-organisme"], "La bact√©rie est une cellule vivante et le micro-organisme regroupe plusieurs types ; donc la bact√©rie est un sous-groupe."],
          [["Engrais", "Pesticide"], "L‚Äôengrais nourrit les plantes et le pesticide tue les nuisibles ; donc l‚Äôun aide, l‚Äôautre prot√®ge."]
        ],
        "Sols & reconnaissance": [
          [["Argile", "Barri√®re"], "L‚Äôargile est imperm√©able et la barri√®re emp√™che la migration des polluants ; donc l‚Äôargile peut servir de barri√®re naturelle."],
          [["Sondage", "Carottage"], "Le sondage explore le sol et le carottage pr√©l√®ve un cylindre intact ; donc le carottage est un sondage sp√©cialis√©."],
          [["Filtre", "Tamis"], "Le filtre retient les petites particules et le tamis les grosses ; donc le tamis est plus grossier que le filtre."]
        ],
        "Chimie environnementale": [
          [["Oxydation", "R√©duction"], "L‚Äôoxydation perd des √©lectrons et la r√©duction en gagne ; donc ce sont des processus inverses."]
        ]
      },
      difficile: {
        "Hydraulique & milieu": [
          [["Perm√©abilit√©", "Transmissivit√©"], "La perm√©abilit√© d√©crit la facilit√© de circulation et la transmissivit√© est cette valeur multipli√©e par l‚Äô√©paisseur ; donc la transmissivit√© d√©pend aussi de la g√©om√©trie."],
          [["Charge", "Pression"], "La charge est l‚Äô√©nergie totale de l‚Äôeau et la pression en est une composante ; donc la charge = pression + altitude."],
          [["Pore", "Vide"], "Le pore est une cavit√© individuelle et le vide est l‚Äôensemble des pores ; donc le vide regroupe tous les pores."],
          [["Nappe", "Aquif√®re"], "La nappe est l‚Äôeau souterraine et l‚Äôaquif√®re est la roche qui la contient ; donc la nappe est le contenu et l‚Äôaquif√®re le contenant."]
        ],
        "Polluants & toxicit√©": [
          [["M√©taux lourds", "Plomb"], "Les m√©taux lourds sont des √©l√©ments toxiques et le plomb en est un exemple ; donc le plomb est un m√©tal lourd sp√©cifique."]
        ],
        "Techniques avanc√©es": [
          [["Absorption", "Adsorption"], "L‚Äôabsorption fait entrer le polluant dans le mat√©riau et l‚Äôadsorption le fixe √† la surface ; donc absorption = int√©rieur, adsorption = surface."],
          [["Barri√®re r√©active", "Barri√®re perm√©able"], "La barri√®re perm√©able filtre l‚Äôeau et la barri√®re r√©active la traite chimiquement ; donc la barri√®re r√©active est une barri√®re perm√©able active."],
          [["Excavation", "Terrassement"], "L‚Äôexcavation enl√®ve de la terre et le terrassement organise et forme le terrain ; donc l‚Äôexcavation est une partie du terrassement."]
        ],
        "R√©glementaire & mod√©lisation": [
          [["Loi", "Arr√™t√©"], "La loi fixe le cadre et l‚Äôarr√™t√© le pr√©cise localement ; donc l‚Äôarr√™t√© applique la loi."],
          [["Dirichlet", "Neumann"], "Dirichlet fixe une valeur et Neumann fixe un flux ; donc Dirichlet impose le r√©sultat et Neumann impose la variation."]
        ],
        "Analyse du transfert": [
          [["Cible", "Vecteur"], "La cible subit la pollution et le vecteur transporte le polluant ; donc le vecteur porte et la cible re√ßoit."]
        ]
      }
    };

    const ROLE_DEFS = {
      "Pollueur infiltr√©": "D√©tient un mot l√©g√®rement diff√©rent. Doit se fondre dans la masse.",
      "Analyste": "Civil standard. Partage le mot commun.",
      "Mister White": "N'a pas de mot. Doit deviner le mot des civils.",
      "Tra√Ætre": "Peut semer la confusion (Civil strat√©gique).",
      "Archiviste": "M√©morise les votes pr√©c√©dents.",
      "Lanceur d'alerte": "Peut pointer un suspect une fois par partie.",
      "Juriste": "Peut annuler un vote.",
      "Maire": "Son vote compte double.",
      "Bin√¥me": "Li√© √† un autre joueur. Si l'un part, l'autre aussi."
    };

    /* ===== VARIABLES ETAT ===== */
    let players = [];
    let publicSpecialRoles = [];
    let sessionCivWord = "";
    let sessionUnderWord = "";
    let sessionContext = "";
    let currentReveal = 0;
    let round = 1;
    let discussionTimer = null;
    let publicRevealQueue = [];
    let publicRevealPointer = 0;

    /* ===== UI GESTION ===== */
    const rolesGrid = document.getElementById('rolesGrid');
    const rolesSelect = document.getElementById('rolesSelect');

    // Init R√¥les UI
    Object.keys(ROLE_DEFS).forEach(r => {
      const d = document.createElement('div');
      d.className = 'role-item';
      d.innerHTML = `<div style="font-weight:700;">${r}</div><div style="opacity:0.8; font-size:13px;">${ROLE_DEFS[r]}</div>`;
      rolesGrid.appendChild(d);

      if(r !== "Analyste" && r !== "Pollueur infiltr√©"){
        const label = document.createElement('label');
        label.className = 'role-item';
        label.style.marginBottom = '8px';
        label.innerHTML = `<input type="checkbox" value="${r}" style="margin-right:10px;"> ${r}`;
        rolesSelect.appendChild(label);
      }
    });

    function show(id){
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      window.scrollTo(0,0);
    }

    // Gestion des Th√®mes dynamiques
    function updateThemes(){
      const diff = document.getElementById('difficultySelect').value;
      const themeSelect = document.getElementById('themeSelect');
      themeSelect.innerHTML = "";
      
      if(GAME_DATA[diff]){
        Object.keys(GAME_DATA[diff]).forEach(themeKey => {
          const opt = document.createElement('option');
          opt.value = themeKey;
          opt.innerText = themeKey;
          themeSelect.appendChild(opt);
        });
      }
    }

    // GENERATEUR DE DICTIONNAIRE
    function renderDictionary(){
        const container = document.getElementById('dictionaryContent');
        container.innerHTML = "";

        Object.keys(GAME_DATA).forEach(diff => {
            // Header Difficult√©
            const diffHeader = document.createElement('div');
            diffHeader.className = "dict-category";
            diffHeader.innerText = "Niveau : " + diff.toUpperCase();
            container.appendChild(diffHeader);

            const themes = GAME_DATA[diff];
            Object.keys(themes).forEach(themeKey => {
                // Header Theme
                const themeHeader = document.createElement('div');
                themeHeader.className = "dict-theme";
                themeHeader.innerText = "üîπ " + themeKey;
                container.appendChild(themeHeader);

                // Items
                themes[themeKey].forEach(pairData => {
                    const words = pairData[0]; // ["MotA", "MotB"]
                    const context = pairData[1]; // Explanation

                    const item = document.createElement('div');
                    item.className = "dict-item";
                    item.innerHTML = `
                        <div class="dict-pair">${words[0]} <span style="opacity:0.6; font-size:0.8em;">vs</span> ${words[1]}</div>
                        <div class="dict-def">${context}</div>
                    `;
                    container.appendChild(item);
                });
            });
        });
    }

    // Init au chargement
    updateThemes();
    buildNameInputs();
    renderDictionary(); // Construit le dico au d√©marrage

    function buildNameInputs(){
      const count = parseInt(document.getElementById('playerCount').value);
      const list = document.getElementById('namesList');
      list.innerHTML = '';
      for(let i=0;i<count;i++){
        const inp = document.createElement('input');
        inp.type="text";
        inp.id = `pname${i}`;
        inp.placeholder = `Nom Joueur ${i+1}`;
        list.appendChild(inp);
      }
    }


    /* ===== LOGIQUE DE JEU ===== */
    function assignRolesAndWords(){
      const count = parseInt(document.getElementById('playerCount').value);
      players = [];
      for(let i=0;i<count;i++){
        let name = document.getElementById(`pname${i}`).value.trim();
        if(!name) name = `Joueur ${i+1}`;
        players.push({ name, role:'Analyste', word:null, alive:true });
      }

      const diff = document.getElementById('difficultySelect').value;
      const theme = document.getElementById('themeSelect').value;
      const pairList = GAME_DATA[diff][theme];
      
      if(!pairList || pairList.length === 0){ alert("Erreur de donn√©es pour ce th√®me."); return; }

      const selectedData = pairList[Math.floor(Math.random() * pairList.length)];
      const wordsPair = selectedData[0];
      sessionContext = selectedData[1];

      if(Math.random() > 0.5){
        sessionCivWord = wordsPair[0];
        sessionUnderWord = wordsPair[1];
      } else {
        sessionCivWord = wordsPair[1];
        sessionUnderWord = wordsPair[0];
      }

      const indices = players.map((_,i)=>i);
      for(let i=indices.length-1; i>0; i--){
        const j = Math.floor(Math.random()*(i+1));
        [indices[i], indices[j]] = [indices[j], indices[i]];
      }

      const pollueurIdx = indices.pop();
      players[pollueurIdx].role = "Pollueur infiltr√©";
      players[pollueurIdx].word = sessionUnderWord;

      let whiteIdx = -1;
      const useWhite = document.querySelector('input[value="Mister White"]')?.checked;
      if(useWhite && players.length >= 4 && indices.length > 0){
         whiteIdx = indices.pop();
         players[whiteIdx].role = "Mister White";
         players[whiteIdx].word = null;
      }

      const specRoles = Array.from(document.querySelectorAll('#rolesSelect input:checked')).map(c=>c.value);
      const finalSpecRoles = specRoles.filter(r => r !== "Mister White");

      finalSpecRoles.forEach(roleName => {
        if(indices.length > 0){
          const idx = indices.pop();
          players[idx].role = roleName;
        }
      });

      indices.forEach(idx => {
        players[idx].role = "Analyste";
      });

      players.forEach(p => {
        if(p.role !== "Pollueur infiltr√©" && p.role !== "Mister White"){
          p.word = sessionCivWord;
        }
      });

      publicRevealQueue = [];
      players.forEach((p,i) => {
        const secretRoles = ["Analyste", "Pollueur infiltr√©", "Mister White"];
        if(!secretRoles.includes(p.role)){
          publicRevealQueue.push({idx:i, role:p.role});
        }
      });
      publicRevealQueue.sort(()=>Math.random()-0.5);
      publicRevealPointer = 0;

      currentReveal = 0;
      round = 1;
      updateRevealUI();
      show('revealScreen');
    }

    function updateRevealUI(){
      const p = players[currentReveal];
      document.getElementById('revealInstr').innerHTML = `Joueur ${currentReveal+1} : <span style="color:var(--accent)">${p.name}</span>, √† toi !`;
      document.getElementById('wordInfo').style.display = 'none';
      document.getElementById('seeBtn').style.display = 'inline-block';
      document.getElementById('wordDisplay').innerText = '';
      document.getElementById('roleLabel').innerText = '';
    }

    function seeMyWord(){
      const p = players[currentReveal];
      document.getElementById('seeBtn').style.display = 'none';
      document.getElementById('wordInfo').style.display = 'block';

      if(p.role === "Mister White"){
        document.getElementById('wordDisplay').innerText = "AUCUN MOT";
        document.getElementById('roleLabel').innerText = "Tu es Mister White. Tu dois deviner le mot des autres.";
      } else {
        document.getElementById('wordDisplay').innerText = p.word;
        if(p.role === "Pollueur infiltr√©"){
          document.getElementById('roleLabel').innerHTML = `Tu es le <strong style="color:#e74c3c">POLLUEUR</strong>. Ton mot est diff√©rent.`;
        } else {
          if(p.role === "Analyste") document.getElementById('roleLabel').innerText = "Tu es un Civil (Analyste).";
          else document.getElementById('roleLabel').innerText = `Tu es Civil avec le r√¥le : ${p.role}`;
        }
      }
    }

    function nextReveal(){
      currentReveal++;
      if(currentReveal >= players.length){
        startDiscussion();
        show('discussionScreen');
      } else {
        updateRevealUI();
      }
    }

    /* ===== JEU : DISCUSSION & VOTE ===== */
    function startDiscussion(){
      document.getElementById('roundNumber').innerText = round;
      document.getElementById('votingArea').style.display = 'none';
      
      const banner = document.getElementById('publicRoleBanner');
      if(publicRevealQueue.length > 0){
        const item = publicRevealQueue[publicRevealPointer % publicRevealQueue.length];
        publicRevealPointer++;
        banner.style.display = 'block';
        banner.innerHTML = `üì¢ INFO PUBLIQUE : <strong>${players[item.idx].name}</strong> est <strong>${item.role}</strong> !`;
      } else {
        banner.style.display = 'none';
      }

      if(discussionTimer) clearInterval(discussionTimer);
      let timeLeft = 90;
      updateTimer(timeLeft);
      discussionTimer = setInterval(()=>{
        timeLeft--;
        updateTimer(timeLeft);
        if(timeLeft<=0) openVoting();
      }, 1000);
    }

    function updateTimer(t){
      const m = Math.floor(t/60);
      const s = t%60;
      document.getElementById('timerDisplay').innerText = `0${m}:${s<10?'0'+s:s}`;
    }

    function openVoting(){
      clearInterval(discussionTimer);
      document.getElementById('votingArea').style.display = 'block';
      const list = document.getElementById('voteList');
      list.innerHTML = '';
      
      players.forEach((p,i) => {
        if(p.alive){
          const div = document.createElement('div');
          div.className = 'vote-item';
          div.innerHTML = `<span>${p.name}</span> <input type="radio" name="vote" value="${i}">`;
          div.onclick = (e) => {
             if(e.target.tagName !== 'INPUT') div.querySelector('input').checked = true;
          };
          list.appendChild(div);
        }
      });
    }

    function collectVotes(){
      const checked = document.querySelector('input[name="vote"]:checked');
      if(!checked){ alert("Votez pour quelqu'un !"); return; }
      
      const victimIdx = parseInt(checked.value);
      const victim = players[victimIdx];
      victim.alive = false;

      const content = document.getElementById('afterContent');
      let html = `<p>üü• <strong>${victim.name}</strong> a √©t√© √©limin√©.</p>`;
      html += `<p>Son r√¥le √©tait : <strong>${victim.role}</strong></p>`;
      html += `<p>Son mot √©tait : <strong>${victim.word || "Aucun"}</strong></p>`;
      
      content.innerHTML = html;

      if(victim.role === "Pollueur infiltr√©"){
        endGame("CIVILS", "Le Pollueur a √©t√© √©limin√© ! Les sols sont prot√©g√©s !");
        return;
      }
      
      const survivors = players.filter(p => p.alive);
      if(survivors.length <= 2){
        const pol = survivors.find(p => p.role === "Pollueur infiltr√©");
        const white = survivors.find(p => p.role === "Mister White");
        
        if(pol) endGame("POLLUEUR", "Le Pollueur a surv√©cu jusqu'√† la fin ! La contamination se r√©pand...");
        else if(white) endGame("MISTER WHITE", "Mister White a surv√©cu sans se faire prendre !");
        else endGame("CIVILS", "Le Pollueur s'est √©limin√© lui-m√™me ? Victoire Civils !");
        return;
      }

      show('afterScreen');
    }

    function proceedAfterVote(){
      round++;
      startDiscussion();
      show('discussionScreen');
    }
    
    function forceFinalReveal(){
       const pol = players.find(p => p.role === "Pollueur infiltr√©" && p.alive);
       if(pol) endGame("POLLUEUR", "Partie arr√™t√©e. Le Pollueur est toujours vivant.");
       else endGame("CIVILS", "Partie arr√™t√©e. Le Pollueur n'est plus en jeu.");
    }

    function endGame(winner, msg){
      show('endScreen');
      document.getElementById('endMessage').innerText = `Victoire : ${winner} ‚Äî ${msg}`;
      
      document.getElementById('endCivWord').innerText = sessionCivWord;
      document.getElementById('endUnderWord').innerText = sessionUnderWord;
      document.getElementById('endContext').innerText = sessionContext;

      const ul = document.getElementById('playersSummary');
      ul.innerHTML = '';
      players.forEach(p => {
        const li = document.createElement('li');
        li.style.marginBottom = "8px";
        li.innerHTML = `${p.alive?'‚úÖ':'üíÄ'} <strong>${p.name}</strong> (${p.role}) : ${p.word || "√ò"}`;
        ul.appendChild(li);
      });
    }

  </script>
</body>
</html>
